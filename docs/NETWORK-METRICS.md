# 网络稳定性指标说明

本文档详细说明新增的网络稳定性监控指标及其在 Grafana 仪表板中的展示。

## 🆕 新增指标

### 1. video_stream_rtt_ms
- **名称**: RTT 往返时间
- **类型**: Gauge
- **单位**: 毫秒 (ms)
- **说明**: 使用 HTTP-FLV 请求的响应时间作为 RTT 的近似值
- **正常范围**: < 500ms
- **告警阈值**: > 1000ms

### 2. video_stream_packet_loss_ratio
- **名称**: 丢包率
- **类型**: Gauge
- **单位**: 比例 (0.0-1.0，即 0%-100%)
- **说明**: 基于视频包 DTS 时间戳连续性估算的丢包率
- **正常范围**: < 5% (0.05)
- **告警阈值**: > 10% (0.1)

### 3. video_stream_network_jitter_ms
- **名称**: 网络抖动
- **类型**: Gauge
- **单位**: 毫秒 (ms)
- **说明**: 视频包到达时间间隔的标准差，反映网络传输的稳定性
- **正常范围**: < 50ms
- **告警阈值**: > 100ms

### 4. video_stream_reconnect_total
- **名称**: 重连次数
- **类型**: Counter
- **单位**: 次
- **说明**: 流检查失败后的累积重连次数
- **正常值**: 0
- **告警阈值**: 频繁增长（每分钟 > 0.1 次）

## 📊 Grafana 面板布局

### 顶部统计卡片（第二行）

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│ 🌐 平均 RTT  │ 📉 平均丢包率 │ 📶 平均抖动  │ 🔄 总重连次数 │
│   500ms      │    2.5%      │    30ms      │     5次      │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

**位置**: y=5, 第二行（第一行是总流数、在线流数等）

**面板说明**:
- **🌐 平均 RTT**: 所有流的平均往返时间
  - 绿色: < 500ms
  - 黄色: 500-1000ms
  - 红色: > 1000ms

- **📉 平均丢包率**: 所有流的平均丢包率
  - 绿色: < 5%
  - 黄色: 5-10%
  - 红色: > 10%

- **📶 平均抖动**: 所有流的平均网络抖动
  - 绿色: < 50ms
  - 黄色: 50-100ms
  - 红色: > 100ms

- **🔄 总重连次数**: 所有流的累计重连次数
  - 绿色: < 10次
  - 黄色: 10-50次
  - 红色: > 50次

### 详细趋势图表（底部）

```
┌────────────────────────────┬────────────────────────────┐
│ 🌐 RTT 往返时间趋势         │ 📉 丢包率趋势               │
│                            │                            │
│   (每条流的 RTT 曲线)       │   (每条流的丢包率曲线)      │
└────────────────────────────┴────────────────────────────┘

┌────────────────────────────┬────────────────────────────┐
│ 📶 网络抖动趋势             │ 🔄 重连次数趋势             │
│                            │                            │
│   (每条流的抖动曲线)        │   (每条流的累积重连曲线)    │
└────────────────────────────┴────────────────────────────┘
```

**位置**: y=73 和 y=81（仪表板底部）

**面板特性**:
- 支持按项目和流名称筛选
- 显示每条流的详细趋势
- 包含最大值、最小值、平均值统计
- 自动 30 秒刷新

## 📈 PromQL 查询

### 统计卡片查询

```promql
# 平均 RTT
avg(video_stream_rtt_ms{project=~"$project", name=~"$name"})

# 平均丢包率
avg(video_stream_packet_loss_ratio{project=~"$project", name=~"$name"})

# 平均抖动
avg(video_stream_network_jitter_ms{project=~"$project", name=~"$name"})

# 总重连次数
sum(video_stream_reconnect_total{project=~"$project", name=~"$name"})
```

### 趋势图查询

```promql
# RTT 趋势（每条流）
video_stream_rtt_ms{project=~"$project", name=~"$name"}

# 丢包率趋势（每条流）
video_stream_packet_loss_ratio{project=~"$project", name=~"$name"}

# 网络抖动趋势（每条流）
video_stream_network_jitter_ms{project=~"$project", name=~"$name"}

# 重连次数趋势（每条流）
video_stream_reconnect_total{project=~"$project", name=~"$name"}
```

## 🎨 可视化说明

### RTT 面板
- **类型**: 时序图 (Time Series)
- **Y轴**: 毫秒
- **阈值**:
  - 绿色区域: 0-500ms
  - 黄色警告线: 500ms
  - 红色告警线: 1000ms
- **图例**: 显示最新值、最大值、最小值、平均值

### 丢包率面板
- **类型**: 时序图 (Time Series)
- **Y轴**: 百分比 (0-100%)
- **填充**: 带透明度渐变
- **阈值**:
  - 绿色区域: 0-5%
  - 黄色警告线: 5%
  - 红色告警线: 10%
- **图例**: 显示最新值、最大值、平均值

### 网络抖动面板
- **类型**: 时序图 (Time Series)
- **Y轴**: 毫秒
- **曲线**: 平滑插值
- **阈值**:
  - 绿色区域: 0-50ms
  - 黄色警告线: 50ms
  - 红色告警线: 100ms

### 重连次数面板
- **类型**: 时序图 (Time Series)
- **Y轴**: 次数
- **曲线**: 阶梯式（因为是累积值）
- **填充**: 带透明度渐变
- **图例**: 显示最新值、最大值、总和

## 🔍 使用场景

### 1. 网络质量评估
查看 **平均 RTT**、**平均丢包率** 和 **平均抖动** 统计卡片，快速了解整体网络质量。

### 2. 问题定位
当某个流出现问题时：
1. 查看该流的 RTT 是否异常升高
2. 查看丢包率是否超过阈值
3. 查看网络抖动是否剧烈波动
4. 查看是否频繁重连

### 3. 趋势分析
通过时序图观察：
- 网络质量的时间变化
- 不同时段的稳定性
- 是否存在周期性问题

### 4. 对比分析
同时查看多条流的网络指标，识别：
- 哪些流的网络质量较差
- 是否某个特定项目的流有问题
- 网络问题是全局的还是局部的

## 🚨 告警建议

### 高 RTT 告警
```yaml
- alert: HighRTT
  expr: video_stream_rtt_ms > 1000
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "RTT 过高"
    description: "{{ $labels.name }} 的 RTT 超过 1 秒"
```

### 高丢包率告警
```yaml
- alert: HighPacketLoss
  expr: video_stream_packet_loss_ratio > 0.1
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "丢包率过高"
    description: "{{ $labels.name }} 的丢包率超过 10%"
```

### 网络抖动告警
```yaml
- alert: HighNetworkJitter
  expr: video_stream_network_jitter_ms > 100
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "网络抖动严重"
    description: "{{ $labels.name }} 的网络抖动超过 100ms"
```

### 频繁重连告警
```yaml
- alert: FrequentReconnects
  expr: rate(video_stream_reconnect_total[5m]) > 0.1
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "频繁重连"
    description: "{{ $labels.name }} 每分钟重连超过 0.1 次"
```

## 🎯 性能指标解读

### RTT (往返时间)
- **优秀**: < 100ms
- **良好**: 100-500ms
- **可接受**: 500-1000ms
- **差**: > 1000ms

### 丢包率
- **优秀**: 0%
- **良好**: < 1%
- **可接受**: 1-5%
- **差**: > 5%
- **严重**: > 10%

### 网络抖动
- **优秀**: < 10ms
- **良好**: 10-50ms
- **可接受**: 50-100ms
- **差**: > 100ms

### 重连次数
- **优秀**: 0 次
- **可接受**: < 3 次/小时
- **需关注**: 3-10 次/小时
- **严重**: > 10 次/小时

## 📖 使用步骤

### 1. 访问仪表板

```
http://localhost:3000/d/video-stream-monitoring
```

### 2. 查看网络指标

**顶部统计卡片**（第二行）:
- 快速查看整体网络状况
- 数值会根据阈值显示不同颜色

**底部趋势图表**:
- 滚动到页面底部
- 查看 4 个网络指标的详细趋势

### 3. 筛选功能

使用顶部的下拉菜单：
- **项目筛选**: 选择特定项目
- **流名称**: 选择特定流

### 4. 时间范围

使用右上角的时间选择器：
- 默认: 最近 1 小时
- 可选: 最近 6 小时、24 小时、7 天等
- 支持自定义时间范围

## 🔧 自定义面板

如果需要修改面板：

1. 在 Grafana UI 中编辑面板
2. 点击右上角的 "Save dashboard"
3. 导出 JSON: Settings → JSON Model
4. 复制 JSON 并替换 `video-stream-dashboard.json`

**注意**: 如果 docker-compose 中 volume 挂载为只读（`:ro`），需要：
1. 先设置 `allowUiUpdates: true`（已配置）
2. 在 UI 中编辑
3. 导出 JSON 保存到本地文件

## 📊 面板总览

仪表板现在包含 **24 个面板**：

### 基础状态（6个）
1. 📊 总流数
2. ✅ 在线流数
3. ❌ 离线流数
4. 📈 成功率
5. 🩺 Healthy 流数
6. ▶️ Playable 流数

### 网络统计（4个）🆕
7. 🌐 平均 RTT
8. 📉 平均丢包率
9. 📶 平均抖动
10. 🔄 总重连次数

### 趋势图表（10个）
11. 🔄 各项目流状态趋势
12. 📊 各项目成功率趋势
13. ⏱️ 响应时间趋势
14. 📊 码率波动
15. 🎬 帧率波动
16. 📋 流状态详情表
17. 📦 数据包计数
18. 🔑 关键帧
19. 🧱 GOP 大小
20. 🌟 质量评分
21. 📉 稳定性评分

### 网络详细图表（4个）🆕
22. 🌐 RTT 往返时间（趋势）
23. 📉 丢包率（趋势）
24. 📶 网络抖动（趋势）
25. 🔄 重连次数（趋势）

## 🎨 颜色方案

### 统计卡片
- **背景颜色**: 根据阈值自动变化
- **绿色**: 正常范围
- **黄色**: 警告范围
- **红色**: 异常范围

### 趋势图表
- **多条曲线**: 使用不同颜色区分各条流
- **阈值线**: 黄色（警告）和红色（告警）
- **填充**: 半透明填充，便于查看重叠区域

## 💡 最佳实践

### 1. 监控重点

**日常监控**:
- 关注顶部的 4 个网络统计卡片
- 颜色异常时深入查看趋势图

**问题排查**:
- 查看具体流的趋势曲线
- 对比正常流和问题流的指标
- 分析问题发生的时间段

### 2. 时间范围选择

- **实时监控**: 最近 5-15 分钟
- **短期分析**: 最近 1-6 小时
- **趋势分析**: 最近 24 小时或 7 天

### 3. 筛选使用

- **按项目**: 关注特定项目的所有流
- **按流名称**: 对比特定几条流
- **All**: 查看全局概况

### 4. 组合分析

结合多个指标综合判断：
```
高 RTT + 高丢包率 + 高抖动 = 网络质量严重问题
正常 RTT + 高丢包率 = 可能是源端问题
高 RTT + 正常丢包率 = 可能是网络延迟问题
频繁重连 = 连接不稳定，需检查源端或网络
```

## 🔗 相关文档

- [API 文档](API.md) - 详细的指标定义和 PromQL 查询
- [README](../README.md) - 项目概述
- [Docker Compose 使用](DOCKER-COMPOSE-README.md) - 部署说明

## 📝 更新历史

- **2025-12-04**: 初始版本，添加 4 个网络稳定性指标及 8 个相关面板

